<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Mark Edmondson" />

<meta name="date" content="2019-05-04" />

<title>Shiny App</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Shiny App</h1>
<h4 class="author"><em>Mark Edmondson</em></h4>
<h4 class="date"><em>2019-05-04</em></h4>



<div id="self-contained-shiny-app" class="section level1">
<h1>Self-contained Shiny app</h1>
<p>This creates a dedicated Docker container that has all the libraries, files and scripts necessary to run your Shiny app. This example uses a local <code>Dockerfile</code> to install the libraries you need, but in addition also copies your Shiny app scripts so its all self-contained and portable.</p>
<p>The Shiny app can then be deployed on new instances.</p>
<p>In summary:</p>
<ol style="list-style-type: decimal">
<li>Create a Dockerfile including copying the Shiny app into the Docker image</li>
<li>Use build triggers or <code>docker_build()</code> to create and push your Shiny image to Google container registry</li>
<li>Start up a Shiny templated Google Compute Engine VM calling your custom Shiny image</li>
<li>Enjoy your Shiny app</li>
</ol>
<p>Once built, you can deploy straight from the Container Registry, so not necessarily needing steps 1 and 2.</p>
<div id="google-container-registry---build-triggers" class="section level3">
<h3>Google Container Registry - Build Triggers</h3>
<p>You can use build triggers from <a href="https://cloud.google.com/container-registry/">Google Container Registry</a> to build the docker image.</p>
<p>This is typically done by pushing up to a GitHub repository with your Dockerfile, which <a href="https://cloud.google.com/container-builder/docs/concepts/creating-build-triggers">triggers a build</a>. You can then construct the name of this docker image directly using <code>gce_tag_container</code>, for use in a Shiny templated <code>gce_vm</code> call.</p>
</div>
<div id="create-a-dockerfile-in-build-folder-including-copying-the-shiny-app-into-the-docker-image" class="section level2">
<h2>Create a Dockerfile in build folder, including copying the Shiny app into the Docker image</h2>
<p>The <code>Dockerfile</code> includes a <code>COPY</code> command to copy necessary Shiny files such as <code>ui.R</code> and <code>server.R</code> into the Docker image.</p>
<p>The Shiny app example below is the <a href="https://mark.shinyapps.io/googleAuthRexample/"><code>googleAuthR</code> demo app</a>, and the build directory can be found via: <code>get_dockerfolder(&quot;shiny-googleAuthRdemo&quot;)</code></p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">FROM</span> rocker/shiny
<span class="ex">MAINTAINER</span> Mark Edmondson (r@sunholo.com)

<span class="co"># install R package dependencies</span>
<span class="ex">RUN</span> apt-get update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install -y \
    libssl-dev \
    ## clean up
    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> clean <span class="dt">\ </span>
    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> -rf /var/lib/apt/lists/ <span class="dt">\ </span>
    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> -rf /tmp/downloaded_packages/ /tmp/*.rds
    
<span class="co">## Install packages from CRAN</span>
<span class="ex">RUN</span> install2.r --error <span class="dt">\ </span>
    <span class="ex">-r</span> <span class="st">'http://cran.rstudio.com'</span> \
    googleAuthR \
    <span class="kw">&amp;&amp;</span> <span class="ex">Rscript</span> -e <span class="st">&quot;devtools::install_github(c('MarkEdmondson1234/googleID')&quot;</span> \
    ## clean up
    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> -rf /tmp/downloaded_packages/ /tmp/*.rds

<span class="co">## assume shiny app is in build folder /shiny</span>
<span class="ex">COPY</span> ./shiny/ /srv/shiny-server/myapp/</code></pre></div>
<p>The <code>COPY</code> command copies from a folder in the same location as the <code>Dockerfile</code>, and then places it within the <code>/srv/shiny-server/</code> folder which is the default location for Shiny apps. This location means that the Shiny app will be avialable at <code>xxx.xxx.xxx.xxx/myapp/</code></p>
<p>The example Dockerfile above installs <code>googleAuthR</code> from CRAN, <code>googleID</code> from GitHub and a Debian dependency for <code>googleAuthR</code> that is needed, <code>libssl-dev</code> via <code>apt-get</code>. Modify this for your own needs.</p>
<div id="public-docker-images" class="section level3">
<h3>Public Docker images</h3>
<p>The <code>FROM</code> field could be a previously made image you or someone else has already created, allowing you to layer on top. The above example is available via a public Google Continer Registry window, made for this purpose, which you can see here: <code>https://console.cloud.google.com/gcr/images/gcer-public?project=gcer-public</code></p>
<p>The <code>shiny-googleauthrdemo</code> is the Dockerfile above - the name for this can be created via the <code>gce_tag_container()</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleComputeEngineR)
<span class="kw">gce_tag_container</span>(<span class="st">&quot;shiny-googleauthrdemo&quot;</span>, <span class="dt">project =</span> <span class="st">&quot;gcer-public&quot;</span>)</code></pre></div>
<p>This can then be added to your Dockerfile:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">FROM</span> gcr.io/gcer-public/shiny-googleauthrdemo
<span class="ex">MAINTAINER</span> Mark Edmondson (r@sunholo.com)

<span class="co"># install R package dependencies</span>
<span class="ex">RUN</span> apt-get update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install -y \
    ##### ADD YOUR DEPENDENCIES
    <span class="co">## clean up</span>
    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> clean <span class="dt">\ </span>
    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> -rf /var/lib/apt/lists/ <span class="dt">\ </span>
    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> -rf /tmp/downloaded_packages/ /tmp/*.rds
    
<span class="co">## Install packages from CRAN</span>
<span class="ex">RUN</span> install2.r --error <span class="dt">\ </span>
    <span class="ex">-r</span> <span class="st">'http://cran.rstudio.com'</span> \
    ##### ADD YOUR CRAN PACKAGES
    <span class="co">##### &amp;&amp; Rscript -e &quot;devtools::install_github( ## ADD YOUR GITHUB PACKAGES )&quot; \</span>
    ## <span class="ex">clean</span> up
    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> -rf /tmp/downloaded_packages/ /tmp/*.rds

<span class="co">## copy your shiny app folder below</span>
<span class="ex">COPY</span> ./shiny/ /srv/shiny-server/myapp/</code></pre></div>
<p>Hopefully more images can be added in the future, along with community contributions. They are rebuilt every commit to the <code>googleComputeEngineR</code> GitHub repo.</p>
</div>
<div id="create-your-shiny-app-and-place-in-subfolder-of-your-build-folder" class="section level3">
<h3>Create your Shiny app and place in subfolder of your build folder</h3>
<p>Once you have the Dockerfile, place it into a folder with this structure alongside your Shiny app:</p>
<pre><code>|
|- /appname/
   |
   |- ui.R
   |- server.R
| Dockerfile
</code></pre>
<p>The file structure for this build is then:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list.files</span>(<span class="kw">get_dockerfolder</span>(<span class="st">&quot;shiny-googleAuthRdemo&quot;</span>), <span class="dt">recursive =</span> <span class="ot">TRUE</span>)
<span class="co"># &quot;Dockerfile&quot;        &quot;shiny/DESCRIPTION&quot; &quot;shiny/readme.md&quot;   &quot;shiny/server.R&quot;    &quot;shiny/ui.R&quot;</span></code></pre></div>
</div>
</div>
<div id="build-your-shiny-app-docker-image" class="section level2">
<h2>Build your Shiny app Docker image</h2>
<p>You have a few options here:</p>
<ul>
<li>Build the Dockerfile image by pushing up to a GitHub repo with a set up <a href="https://cloud.google.com/container-builder/docs/concepts/creating-build-triggers">build trigger</a></li>
<li>Build locally or within a custom GCE image using <code>docker_build</code></li>
<li>Use a premade Shiny app that someone else has created</li>
</ul>
<p>Building images may take 10mins or so, especially if its the first layer of the image.</p>
</div>
<div id="start-up-a-shiny-templated-google-compute-engine-vm-with-your-custom-image" class="section level2">
<h2>Start up a Shiny templated Google Compute Engine VM with your custom image</h2>
<p>Start up a Shiny templated image, which makes sure the right ports are open etc. but also supply the <code>dynamic_image</code> argument pointing at the Docker image you have built in previous step.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## make new Shiny template VM for your self-contained Shiny app
vm &lt;-<span class="st"> </span><span class="kw">gce_vm</span>(<span class="st">&quot;myapp&quot;</span>, 
             <span class="dt">template =</span> <span class="st">&quot;shiny&quot;</span>,
             <span class="dt">predefined_type =</span> <span class="st">&quot;n1-standard-2&quot;</span>,
             <span class="dt">dynamic_image =</span> <span class="kw">gce_tag_container</span>(<span class="st">&quot;custom-shiny-app&quot;</span>, <span class="st">&quot;your-project&quot;</span>))</code></pre></div>
<div id="re-deploy-already-built-shiny-app-to-another-vm" class="section level3">
<h3>Re-deploy already built Shiny app to another VM</h3>
<p>Now you have a built app, you can deploy it to other instances simply by specifying the build shiny image. If using the recommended Build trigger method, you can specify development or production folders in your GitHub repository. You will need to restart a Shiny VM to load the latest build.</p>
</div>
</div>
<div id="tidy-up" class="section level2">
<h2>Tidy up</h2>
<p>Clean up the VMs to avoid unnecessary costs:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># delete build VM</span>
<span class="kw">gce_vm_delete</span>(vm)</code></pre></div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
